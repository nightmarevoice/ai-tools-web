# 搜索配额预检查功能

## 功能概述

在用户执行搜索前,预先检查配额状态,并在搜索弹窗中直接提示限流信息,引导用户登录。

**核心特性**:
- ✅ 弹窗打开时自动检查配额状态
- ✅ 搜索提交前进行配额验证
- ✅ 智能分层提示(警告/提示)
- ✅ 完整多语言支持(中文/英文/繁中/日语/韩语)
- ✅ 热门搜索不受配额限制

## 实现细节

### 1. API 集成

**文件**: `lib/api/search.ts`

新增 `checkQuota()` 方法:
- 接口: `GET /app-search/quota-status`
- 自动携带 `visitor_id` (从 localStorage 获取)
- 返回配额状态信息

### 2. 类型定义

**文件**: `types/api.ts`

新增 `QuotaStatus` 接口:
```typescript
interface QuotaStatus {
  allowed: boolean          // 是否允许下次搜索
  remaining: number          // 剩余搜索次数
  need_login: boolean        // 是否需要登录
  current_count: number      // 当前已使用次数
  is_authenticated: boolean  // 用户是否已认证
  limit: number              // 该用户类型的总限制次数
  quota_exceeded: boolean    // 是否已超过配额
  quota_enabled: boolean     // 配额功能是否启用
}
```

### 3. UI 组件更新

**文件**: `components/demo-search-bar.tsx`

#### 新增状态管理
- `quotaStatus`: 配额状态数据
- `showQuotaWarning`: 是否显示限流警告
- `isCheckingQuota`: 是否正在检查配额

#### 预检查流程
1. **弹窗打开时** → 自动调用 `checkQuota()` 获取配额状态
2. **搜索提交时** → 检查 `quotaStatus.allowed`
   - ✅ `allowed = true`: 正常跳转搜索页面
   - ❌ `allowed = false`: 显示限流提示,阻止搜索

#### UI 提示层级

**1. 限流警告 (红色)**
- 触发条件: `allowed = false` 且用户尝试搜索
- 显示内容:
  - 匿名用户: "搜索次数已用完" + "立即登录"按钮
  - 已登录用户: "今日配额已达上限" + 明日提示
- 位置: 搜索框上方

**2. 配额提示 (黄色)**
- 触发条件: `remaining ≤ 2` 且 `remaining > 0`
- 显示内容: "您还剩 X 次搜索机会"
- 位置: 搜索框上方

## 用户体验优化

### 场景 1: 匿名用户首次访问
```
弹窗打开 → 检查配额 (2/2 剩余) → 正常搜索
```

### 场景 2: 匿名用户剩余 1 次
```
弹窗打开 → 检查配额 (1/2 剩余) → 显示黄色提示 → 允许搜索
```

### 场景 3: 匿名用户配额用完
```
弹窗打开 → 检查配额 (0/2 剩余) → 用户输入搜索词 → 点击搜索
→ 显示红色警告 + "立即登录"按钮 → 阻止搜索
```

### 场景 4: 已登录用户配额充足
```
弹窗打开 → 检查配额 (40/50 剩余) → 正常搜索
```

### 场景 5: 已登录用户配额用完
```
弹窗打开 → 检查配额 (0/50 剩余) → 用户输入搜索词 → 点击搜索
→ 显示红色警告 (无登录按钮) → 阻止搜索
```

## 技术亮点

1. **非侵入式检查**: 配额检查失败时不影响用户体验,允许继续搜索
2. **智能提示**: 根据剩余次数和认证状态,动态显示不同级别的提示
3. **主动引导**: 匿名用户达到限制时,提供"立即登录"快捷入口
4. **全流程覆盖**: 搜索框提交和热门搜索点击都会进行配额检查
5. **加载状态**: 检查配额期间显示加载动画,禁用搜索按钮

## 测试建议

### 功能测试
1. 匿名用户 - 配额充足时搜索
2. 匿名用户 - 配额剩余 1 次时提示
3. 匿名用户 - 配额用完时限流提示
4. 匿名用户 - 点击"立即登录"跳转
5. 已登录用户 - 配额用完时提示
6. 网络失败 - 配额检查失败时降级处理

### UI 测试
1. 限流警告样式(红色)
2. 配额提示样式(黄色)
3. 加载状态动画
4. 深色模式适配
5. 响应式布局

### 边界测试
1. visitor_id 不存在
2. API 超时或失败
3. quota_enabled = false
4. 快速重复点击搜索按钮

## 后续优化建议

1. **缓存配额状态**: 避免频繁请求,提升性能
2. **国际化支持**: 提示文案支持多语言
3. **实时更新**: 搜索后更新剩余次数显示
4. **优雅降级**: API 失败时提供友好提示
