# 429 错误处理 - 测试清单

## 📋 功能测试清单

### ✅ 基础功能测试

- [ ] **测试 1: 触发 429 错误**
  - 快速连续发起 5+ 个搜索请求
  - 期望：触发 429 错误

- [ ] **测试 2: Toast 提示显示**
  - 触发 429 错误后
  - 期望：屏幕右上角显示 Toast："请求频率超限，请登录账号"

- [ ] **测试 3: localStorage 清除**
  - 打开浏览器开发者工具 → Application → Local Storage
  - 触发 429 错误前：存在 `auth_user` 和 `auth_access_token`
  - 触发 429 错误后：这两个键已被删除
  - 期望：✅ 已清除

- [ ] **测试 4: 导航栏状态更新**
  - 登录状态下触发 429 错误
  - 期望：导航栏从"用户头像+下拉菜单"变为"登录按钮"

### ✅ 边界情况测试

- [ ] **测试 5: 未登录状态下的 429**
  - 在未登录状态下触发 429
  - 期望：显示 Toast，不会报错

- [ ] **测试 6: 多次 429 错误**
  - 连续触发多次 429 错误
  - 期望：每次都显示 Toast，不会重复清除 localStorage

- [ ] **测试 7: 其他错误码**
  - 触发 400、401、500 等其他错误码
  - 期望：不会清除 localStorage，不会触发登出

### ✅ 跨标签页测试

- [ ] **测试 8: 多标签页同步**
  - 打开两个浏览器标签页
  - 在标签页 A 触发 429 错误
  - 期望：标签页 B 的导航栏也自动更新为未登录状态

### ✅ UI/UX 测试

- [ ] **测试 9: Toast 样式**
  - 检查 Toast 消息的样式是否美观
  - 检查 Toast 是否会自动消失（约 3-5 秒）

- [ ] **测试 10: 导航栏过渡**
  - 检查导航栏从登录到未登录状态的过渡是否平滑

### ✅ 集成测试

- [ ] **测试 11: 搜索功能集成**
  - 在搜索页面触发 429
  - 期望：搜索组件显示错误状态，Toast 显示，导航栏更新

- [ ] **测试 12: 数据加载集成**
  - 在应用列表页面触发 429
  - 期望：列表显示错误状态，Toast 显示，导航栏更新

## 🔍 手动测试步骤

### 测试场景 A：正常流程

```
1. 打开应用首页
2. 点击"登录"
3. 输入正确的邮箱和密码
4. 登录成功，导航栏显示用户头像
5. 在搜索框快速连续输入并搜索 5 次
6. 观察是否触发 429 错误
```

**期望结果：**
- ✅ Toast 提示："请求频率超限，请登录账号"
- ✅ 导航栏变为"登录"按钮
- ✅ localStorage 中的 `auth_user` 和 `auth_access_token` 已清除

### 测试场景 B：跨标签页同步

```
1. 打开浏览器标签页 A，登录
2. 打开新标签页 B，访问同一应用（应该也是登录状态）
3. 在标签页 A 触发 429 错误
4. 切换到标签页 B
5. 观察标签页 B 的导航栏状态
```

**期望结果：**
- ✅ 标签页 B 的导航栏也变为"登录"按钮
- ✅ 标签页 B 的 localStorage 也被清除

### 测试场景 C：错误恢复

```
1. 触发 429 错误（未登录状态）
2. 等待几分钟
3. 重新登录
4. 正常使用应用功能
```

**期望结果：**
- ✅ 登录成功后可以正常使用
- ✅ 不会有残留的错误状态

## 🧪 开发环境模拟测试

### 方法 1：修改 API 客户端（临时）

在 `lib/api/client.ts` 中临时添加模拟代码：

```typescript
async get<T>(endpoint: string, params?: Record<string, any>) {
  // 🧪 模拟 429 错误（仅用于测试）
  if (endpoint.includes('/search') && Math.random() > 0.5) {
    const mockResponse = new Response(
      JSON.stringify({ detail: 'Rate limit exceeded' }),
      { status: 429, statusText: 'Too Many Requests' }
    )
    await this.handleError(mockResponse)
  }
  
  // 正常逻辑...
}
```

### 方法 2：使用 Mock Service Worker (MSW)

创建 `mocks/handlers.ts`:

```typescript
import { rest } from 'msw'

export const handlers = [
  rest.get('/api/*', (req, res, ctx) => {
    // 模拟 429 错误
    return res(
      ctx.status(429),
      ctx.json({ detail: 'Rate limit exceeded' })
    )
  })
]
```

### 方法 3：使用浏览器开发者工具

1. 打开 Chrome DevTools
2. Network 标签 → 右键请求 → "Override content"
3. 修改响应状态码为 429

## 📊 测试结果记录表

| 测试项 | 状态 | 备注 | 测试人 | 日期 |
|-------|------|------|--------|------|
| 测试 1: 触发 429 | ⬜ |  |  |  |
| 测试 2: Toast 显示 | ⬜ |  |  |  |
| 测试 3: localStorage 清除 | ⬜ |  |  |  |
| 测试 4: 导航栏更新 | ⬜ |  |  |  |
| 测试 5: 未登录状态 429 | ⬜ |  |  |  |
| 测试 6: 多次 429 | ⬜ |  |  |  |
| 测试 7: 其他错误码 | ⬜ |  |  |  |
| 测试 8: 跨标签页同步 | ⬜ |  |  |  |
| 测试 9: Toast 样式 | ⬜ |  |  |  |
| 测试 10: 导航栏过渡 | ⬜ |  |  |  |
| 测试 11: 搜索集成 | ⬜ |  |  |  |
| 测试 12: 数据加载集成 | ⬜ |  |  |  |

**图例：**
- ⬜ 待测试
- ✅ 通过
- ❌ 失败
- ⚠️ 部分通过

## 🐛 缺陷报告模板

如果测试发现问题，请使用以下模板报告：

```markdown
### 缺陷描述
[简要描述问题]

### 复现步骤
1. 
2. 
3. 

### 期望结果
[应该发生什么]

### 实际结果
[实际发生了什么]

### 环境信息
- 浏览器：
- 版本：
- 操作系统：

### 截图
[如果适用，添加截图]

### 其他信息
[任何其他相关信息]
```

## ✅ 验收标准

所有测试项必须通过才能认为功能完成：

- ✅ 所有基础功能测试通过
- ✅ 所有边界情况测试通过
- ✅ 跨标签页同步正常
- ✅ UI/UX 符合预期
- ✅ 集成测试无问题
- ✅ 无 TypeScript 编译错误
- ✅ 无 linter 警告或错误

## 📝 测试完成签名

- [ ] 功能测试完成
- [ ] 集成测试完成
- [ ] UI/UX 测试完成
- [ ] 文档已更新

**测试负责人：** _______________  
**测试日期：** _______________  
**审核人：** _______________  
**审核日期：** _______________



